# [BIRD] Dao設計書

管理番号：DN-030110-021.01  
分類：Dao設計書  
作成者：王増文  
作成日：2018/09/06  
更新者：王増文  
更新日：2018/09/06

## 変更履歴

### 承認履歴

| バージョン | 変更管理NO | 作成担当者 | 作成日付 | レビュー担当者 | レビュー日付 | 承認担当者 | 承認日付 |
|------------|------------|------------|----------|----------------|--------------|------------|----------|
| 01 | ネット注文帳票 | 王増文 | 2018/09/06 | 田村雄一 | 2018/09/06 | 竹内裕二 | 2018/09/06 |

### 変更内容

| バージョン | 変更内容 |
|------------|----------|
| 01 | 新規作成 |

## 設定＆実行

エンティティ出力先：`C:\Temp`

### 作成対象シート

- 変更履歴
- ネット注文帳票情報取得(NetOrderReportDataDao)

## ネット注文帳票情報 (NetOrderReportDataDao)

### エンティティ情報

テーブル：BT63SNIP  
パッケージ：`jp.co.isid.mos.bird.bizreport.netorderreport.entity.NetOrderReport`

### プロパティ一覧

| プロパティ名 | 論理名 | Java型 | 列型 | 参照 | 対象テーブル |
|--------------|--------|--------|------|------|--------------|
| jigyouCd | 事業本部コード | java.lang.String | - | JIGYOU_CD | BM10GSIB |
| jigyouName | 事業本部名称 | java.lang.String | - | JIGYOU_NAME | BM10GSIB |
| slareaCd | 営業エリアコード | java.lang.String | - | SLAREA_CD | BM10GSIB |
| slareaName | 営業エリア名称 | java.lang.String | - | SLAREA_NAME | BM10GSIB |
| sibuCd | 支部コード | java.lang.String | - | SIBU_CD | BM01TENM |
| sibuName | 支部名称 | java.lang.String | - | SIBU_NAME | BM10GSIB |
| areaDai | 支部取込コード | java.lang.String | - | AREA_DAI | BM01TENM |
| areaName | 支部取込名 | java.lang.String | - | AREA_NAME | BM10GSIB |
| miseCd | 店コード | java.lang.String | - | MISE_CD | BM45ZDAY |
| miseNameKj | 店名称 | java.lang.String | - | MISE_NAME_KJ | BM01TENM |
| onerCd | オーナーコード | java.lang.String | - | ONER_CD | BM01TENM |
| onerNameKj | オーナー名称 | java.lang.String | - | ONER_NAME_KJ | BM11ONER |
| otherKin7 | ネットテイク金額 | java.lang.String | - | SUM(B1.OTHER_KIN_7) | BT63SNIP |
| otherKin8 | ネット宅配金額 | java.lang.String | - | SUM(B1.OTHER_KIN_8) | BT63SNIP |
| eat_kin | EAT-IN金額 | java.lang.String | - | SUM(B1.EAT_KIN) | BT63SNIP |
| takeKin | TAKE-OUT金額 | java.lang.String | - | SUM(B1.TAKE_KIN) | BT63SNIP |
| telKin | TEL-ORDER金額 | java.lang.String | - | SUM(B1.TEL_KIN) | BT63SNIP |
| driveKin | DRV-TH金額 | java.lang.String | - | SUM(B1.DRIVE_KIN) | BT63SNIP |
| otherKin1 | 宅配金額 | java.lang.String | - | SUM(B1.OTHER_KIN_1) | BT63SNIP |
| otherKin2 | 外販金額 | java.lang.String | - | SUM(B1.OTHER_KIN_2) | BT63SNIP |
| otherKen7 | ネットテイク件数 | java.lang.String | - | SUM(B1.OTHER_KEN_7) | BT63SNIP |
| otherKen8 | ネット宅配件数 | java.lang.String | - | SUM(B1.OTHER_KEN_8) | BT63SNIP |
| eatKen | EAT-IN件数 | java.lang.String | - | SUM(B1.EAT_KEN) | BT63SNIP |
| takeKen | TAKE-OUT件数 | java.lang.String | - | SUM(B1.TAKE_KEN) | BT63SNIP |
| telKen | TEL-ORDER件数 | java.lang.String | - | SUM(B1.TEL_KEN) | BT63SNIP |
| driveKen | DRV-TH件数 | java.lang.String | - | SUM(B1.DRIVE_KEN) | BT63SNIP |
| otherKen1 | 宅配件数 | java.lang.String | - | SUM(B1.OTHER_KEN_1) | BT63SNIP |
| otherKen2 | 外販件数 | java.lang.String | - | SUM(B1.OTHER_KEN_2) | BT63SNIP |
| otherKin7Zen | 前年ネットテイク金額 | java.lang.String | - | SUM(B2.OTHER_KIN_7) | BT63SNIP |
| otherKin8Zen | 前年ネット宅配金額 | java.lang.String | - | SUM(B2.OTHER_KIN_8) | BT63SNIP |
| eatKinZen | 前年EAT-IN金額 | java.lang.String | - | SUM(B2.EAT_KIN) | BT63SNIP |
| takeKinZen | 前年TAKE-OUT金額 | java.lang.String | - | SUM(B2.TAKE_KIN) | BT63SNIP |
| telKinZen | 前年TEL-ORDER金額 | java.lang.String | - | SUM(B2.TEL_KIN) | BT63SNIP |
| driveKinZen | 前年DRV-TH金額 | java.lang.String | - | SUM(B2.DRIVE_KIN) | BT63SNIP |
| otherKin1Zen | 前年宅配金額 | java.lang.String | - | SUM(B2.OTHER_KIN_1) | BT63SNIP |
| otherKin2Zen | 前年外販金額 | java.lang.String | - | SUM(B2.OTHER_KIN_2) | BT63SNIP |
| otherKen7Zen | 前年ネットテイク件数 | java.lang.String | - | SUM(B2.OTHER_KEN_7) | BT63SNIP |
| otherKen8Zen | 前年ネット宅配件数 | java.lang.String | - | SUM(B2.OTHER_KEN_8) | BT63SNIP |
| eatKenZen | 前年EAT-IN件数 | java.lang.String | - | SUM(B2.EAT_KEN) | BT63SNIP |
| takeKenZen | 前年TAKE-OUT件数 | java.lang.String | - | SUM(B2.TAKE_KEN) | BT63SNIP |
| telKenZen | 前年TEL-ORDER件数 | java.lang.String | - | SUM(B2.TEL_KEN) | BT63SNIP |
| driveKenZen | 前年DRV-TH件数 | java.lang.String | - | SUM(B2.DRIVE_KEN) | BT63SNIP |
| otherKen1Zen | 前年宅配件数 | java.lang.String | - | SUM(B2.OTHER_KEN_1) | BT63SNIP |
| otherKen2Zen | 前年外販件数 | java.lang.String | - | SUM(B2.OTHER_KEN_2) | BT63SNIP |

## Dao情報

### ネット注文帳票情報 (NetOrderReportDataDao)

パッケージ：`jp.co.isid.mos.bird.bizreport.netorderreport.dao.NetOrderReportDataDao`

### ネット注文帳票情報検索 (selectNetOrderReport)

#### パラメータ情報

| パラメータ名 | 説明 |
|--------------|------|
| 検索FROM日付 | 検索開始日付 |
| 検索TO日付 | 検索終了日付 |
| ソート順キー | ソート順を指定するキー |

#### 使用テーブル

| テーブル名 | テーブルID | 補足 |
|------------|------------|------|
| 営業日報（日次） | BT63SNIP | |
| 前年営業日情報 | BM45ZDAY | |
| グループ統合オーナマスタ | BM11ONER | |
| 店統合マスタ | BM01TENM | |
| 汎用店舗グループ（支部） | BM10GSIB | |
| ネット注文帳票除外店舗マスタ | BM82NOJT | |

### サブクエリー：本年データ

#### JOIN情報

| 項目 | 営業日報（日次） | 前年営業日情報 | グループ統合オーナマスタ | 店統合マスタ | 汎用店舗グループ（支部） | ネット注文帳票除外店舗マスタ |
|------|------------------|----------------|--------------------------|--------------|--------------------------|------------------------------|
| テーブル | BT63SNIP | BM45ZDAY | BM11ONER | BM01TENM | BM10GSIB | BM82NOJT |
| カラム | 会社コード | ⇔会社コード | ⇔会社コード | ⇔会社コード | ⇔会社コード | |
| | 店舗コード | ⇔店舗コード | | ⇔店舗コード | | |
| | 営業日 | ⇔営業日 | | | | |
| | | | | エリア大コード | ⇔支部コード | |
| | | | オーナーコード | ⇔オーナーコード | | |
| | | 会社コード, 店舗コード | | | | NOT IN (会社コード, 店舗コード) |

#### 矢印について

- `→`、`←`：outerジョイン。矢印が向いている方がメイン
- `⇔`：innerジョイン

### サブクエリー：前年データ

#### JOIN情報

| 項目 | 営業日報（日次） | 前年営業日情報 | グループ統合オーナマスタ | 店統合マスタ | 汎用店舗グループ（支部） | ネット注文帳票除外店舗マスタ |
|------|------------------|----------------|--------------------------|--------------|--------------------------|------------------------------|
| テーブル | BT63SNIP | BM45ZDAY | BM11ONER | BM01TENM | BM10GSIB | BM82NOJT |
| カラム | 会社コード | ⇔会社コード | ⇔会社コード | ⇔会社コード | ⇔会社コード | |
| | 店舗コード | ⇔前年同月店舗コード | | ⇔店舗コード | | |
| | 営業日 | ⇔前年同月営業日 | | | | |
| | | | | エリア大コード | ⇔支部コード | |
| | | | オーナーコード | ⇔オーナーコード | | |
| | | 会社コード, 店舗コード | | | | NOT IN (会社コード, 店舗コード) |

### 本年データと前年データの結合

| 項目 | 本年データ | 前年データ |
|------|------------|------------|
| カラム | 全てunion all | 全てunion all |

### 条件

```sql
BM45ZDAY.EIGYO_DT BETWEEN パラメータ.検索FROM日付 AND パラメータ.検索TO日付
```

### ソート情報

#### パラメータのソートキー＝「data」の場合

| カラム | 順序 |
|--------|------|
| JIGYOU_CD | 昇順 |
| SLAREA_CD | 昇順 |
| SIBU_CD | 昇順 |
| AREA_DAI | 昇順 |
| MISE_CD | 昇順 |

#### パラメータのソートキー＝「data_area_dai」の場合

| カラム | 順序 |
|--------|------|
| AREA_DAI | 昇順 |
| MISE_CD | 昇順 |

---

## 読み取りが難しかった項目

以下の項目は、Excelファイルからの変換時に読み取りが困難であった、または情報が失われた可能性がある項目です。

### Excel変換に起因する問題

1. **日付データの変換**: Excelファイル内の日付はシリアル値（例：43349.0）として格納されており、2018/09/06形式に変換しました。Excelの日付基準系（1900年/1904年）は未確認のため、原本での表示確認を推奨します。

2. **結合セル・段組みの構造**: JOIN情報の表は複数行で1つの意味を構成する複雑な構造となっており、行単位の抽出では「どの列がどの見出しに属するか」「空欄が"なし"なのか"同上/継続"なのか」の判別が困難でした。

3. **文字化けの可能性**: 一部のセルで「パラメータ」が「パラメ��タ」のように文字化けしている箇所がありました。該当箇所は原文の表記が判別できなかったため、原本Excel上での表示確認が必要です。

4. **書式情報の欠落**: Excelの結合セル、罫線、注記、コメント、色、脚注、別シート参照などのレイアウト情報は、テキスト抽出では反映されていません。

5. **末尾の空白文字**: SQL参照式の一部に末尾の空白文字（例：`SUM(B1.EAT_KIN)    `）が含まれていましたが、マークダウンでは除去しています。

6. **全角スペース**: 一部のセルに全角スペース（U+3000）が含まれており、表示上は空白に見えますが、実際には文字が存在します。

---

## 仕様上の不明点・不明瞭な点

以下の項目は、設計書の仕様として不明確または追加の確認が必要な点です。

### SQL・クエリに関する不明点

1. **B1/B2の別名定義**: プロパティ一覧の参照列に記載されている`SUM(B1.xxx)`や`SUM(B2.xxx)`の「B1」「B2」が何の別名（本年/前年のサブクエリ？テーブル別名？）かの定義が明示されていません。

2. **SELECT句・GROUP BY句の未記載**: 集計式（SUM関数）は記載されていますが、SELECT句全体やGROUP BYキーが明示されていないため、集計粒度（店舗別、日別、期間合計など）を再現できません。

3. **JOIN種別の曖昧さ**: 「outer/innerの矢印ルール」は説明されていますが、実際にどの結合がouterでどちら向きかが表から一意に読み取れません。NULL許容や欠損データ時の扱いが曖昧です。

4. **除外条件の詳細**: BM82NOJT（ネット注文帳票除外店舗マスタ）のNOT IN条件が「(会社コード, 店舗コード)」レベルでしか記載されておらず、実際の列名、キーの組み合わせ、NULL時の挙動が不明です。

5. **UNION ALLの結果構造**: 本年データと前年データをUNION ALLで結合した後、本年/前年を識別する列があるのか、同一行に並ぶのか別行なのかが記載されていません。

### パラメータに関する不明点

1. **日付パラメータの形式**: 検索FROM日付・検索TO日付のフォーマット（YYYYMMDD？タイムスタンプ？）、タイムゾーン、営業日の概念との関係が未記載です。

2. **BETWEEN条件の包含**: 検索FROM日付とTO日付がBETWEEN条件に含まれるか（境界値の扱い）が明示されていません。

3. **ソート順キーの許容値**: ソート順キーは「data」と「data_area_dai」の2つが記載されていますが、デフォルト値、未指定時の挙動、その他の値が指定された場合の挙動、NULL時の扱いが未記載です。

### データ型に関する不明点

1. **全プロパティがString型**: 金額・件数など本来数値型であるべき項目も含め、全てのプロパティがjava.lang.Stringとして定義されています。これが帳票出力の都合なのか、設計書の簡略化なのかが不明です。

2. **列型が全て「-」**: 全プロパティの列型が「-」となっており、実際のデータベース列型との対応が不明です。

### 前年データに関する不明点

1. **前年同月の定義**: 「前年同月店舗コード」「前年同月営業日」と記載されていますが、前年同月をどのように定義するか（閏年の扱い、存在しない日付の扱いなど）が未記載です。

2. **前年データが存在しない場合の扱い**: 新規店舗など前年データが存在しない場合の挙動（NULL？除外？）が明示されていません。
