# ネット注文帳票 マイグレーション観点（たたき台）

## 1. 前提とスコープ

### 1.1 参照元
- rules配下のファイル
- ソースコード（bird/, birdframework/）

### 1.2 対象機能
- ネット注文帳票（機能ID: BBR019）

### 1.3 仕様変更
- なし（現行仕様を維持）

### 1.4 新技術スタック
| レイヤー | 現行 | 移行先 |
|---------|------|--------|
| フロントエンド | JSF + Seasar2 Maya | Angular |
| バックエンド | Seasar2 (S2Container) | Spring Boot |
| ORM | Seasar2 DAO | Spring Data JPA / Hibernate |
| データベース | 現行DB | PostgreSQL |
| アーキテクチャ | - | レイヤードアーキテクチャ |
| インフラ | - | コンテナベース（非サーバーレス） |

---

## 2. 現行アーキテクチャ構造

### 2.1 コンポーネント構成（ソースコード根拠: netorderReport.dicon）

```
画面(JSF/Maya)
    ↓
Action (netorderAction: NetOrderReportDownloadActionImpl) [request scope]
    ↓
Logic層
    ├── conditionLogic: ConditionLogicImpl (検索条件取得)
    ├── excelOutputLogic: NetOrderReportExcelLogicImpl (Excel生成)
    ├── netorderReportDownloadLogic: NetOrderReportDownloadLogicImpl (ファイルパス管理)
    └── netOrderReportPdfLogic: NetOrderReportPdfLogicImpl (PDFダウンロード)
    ↓
DAO (netOrderReportDataDao: NetOrderReportDataDao)
    ↓
帳票生成 (Apache POI)
    ↓
PDF変換 (JODConverter + LibreOffice)
    ↓
ダウンロード (fileDownloadAction: FileDownloadActionImpl)
```

### 2.2 DIコンポーネントスコープ
| コンポーネント | スコープ | クラス |
|---------------|---------|--------|
| searchDto | session | SearchDto |
| netorderReportDownloadDto | session | NetOrderReportDownloadDto |
| BirdUserInfo | session | BirdUserInfo |
| BirdDateInfo | session | BirdDateInfo |
| netorderAction | request | NetOrderReportDownloadActionImpl |
| fileDownloadAction | request | FileDownloadActionImpl |
| Logic/DAO | singleton | 各Implクラス |

### 2.3 Action ID一覧（ソースコード根拠: NetOrderReportDownloadActionImpl.java）
| Action ID | メソッド | 処理内容 |
|-----------|---------|---------|
| BBR019A01 | initialize() | ページ初期化 |
| BBR019A02 | checkParamater() | パラメータチェック |
| BBR019A03 | downloadExcel() | Excel形式でダウンロード |
| BBR019A04 | downloadPdf() | PDF形式でダウンロード |
| BBR019A05 | modoru() | ダウンロード画面から戻る |

### 2.4 Logic ID一覧
| Logic ID | クラス | 処理内容 |
|----------|--------|---------|
| BBR019L01 | ConditionLogicImpl | 検索条件取得 |
| BBR019L02 | NetOrderReportDownloadLogicImpl | ファイル名取得 |
| BBR019L03 | NetOrderReportExcelLogicImpl | 帳票データ取得・Excel生成 |
| BBR019L04 | NetOrderReportPdfLogicImpl | PDFダウンロード |

---

## 3. 現行機能仕様（ソースコードからの抽出）

### 3.1 画面フロー（ソースコード根拠: netorderReport.html）

```
[初期表示]
    ↓ netorderAction.initialize()
[条件入力画面]
    ├── 対象期間選択（プルダウン）
    │   ├── 対象年月 (MONTH)
    │   └── 期間指定 (DAYS)
    ├── 期間指定
    │   ├── 対象年月: kikanYM (yyyyMM形式)
    │   └── 期間指定: kikanFrom～kikanTo (yyyyMMdd形式)
    ↓
[ダウンロードリンク]
    ├── [EXCELファイル] → checkDownloadExcel() → downloadExcel()
    └── [PDFファイル(予定)] → checkDownloadPdf() → downloadPdf()
    ↓
[待機画面] (downloadFlg=true時に表示)
    ↓
[戻るボタン] → modoru()
```

### 3.2 入力項目と検証ルール

#### 3.2.1 対象期間（ソースコード根拠: TaishoKikan.java, SearchDto.java）
| コード | 表示名 | 説明 |
|--------|--------|------|
| MONTH | 対象年月 | 月単位での指定 |
| DAYS | 期間指定 | 日付範囲での指定 |

#### 3.2.2 プルダウン生成ルール（ソースコード根拠: ConditionLogicImpl.java）
- **対象年月リスト**: 過去14ヶ月分（kikanYmList.subList(0, 14)）
- **期間指定From/Toリスト**: DISPLAY_DAY_MONTH定数で決まる期間の日付リスト

#### 3.2.3 バリデーション（ソースコード根拠: NetOrderReportDownloadActionImpl.java）

| チェック項目 | 条件 | エラーメッセージ | 例外クラス |
|-------------|------|-----------------|-----------|
| 対象期間必須 | taishoKikanCdがnull | "対象年月" | NotNullException |
| FROM<=TO | kikanFrom > kikanTo | "期間指定FROM <= TOを" | ConstraintsViolationException |
| 最大期間 | 期間が1年超過 | "期間指定は最長1年間までとしてください。" | GenericMessageException |
| 排他チェック | ロックファイル存在 | "現在、他のユーザーにて帳票作成中です。しばらく経ってから再度実行してください。" | GenericMessageException |

### 3.3 排他制御（ソースコード根拠: NetOrderReportDownloadActionImpl.java）

#### 3.3.1 ロックファイル仕様
- **ファイル名**: `net_order.lock`
- **配置場所**: `{filePathNetOrderReport}/net_order.lock`
- **タイムアウト**: 5分（1000L*60*5 ミリ秒）

#### 3.3.2 ロック処理フロー
```
checkLock():
    IF ロックファイル存在
        IF 最終更新から5分以上経過
            → ファイル削除して再作成（不正残留と判断）
        ELSE
            → GenericMessageException（他ユーザー使用中）
    ELSE
        → ロックファイル作成

unlock():
    IF ロックファイル存在
        → ファイル削除
```

### 3.4 出力仕様

#### 3.4.1 Excelファイル（ソースコード根拠: NetOrderReportExcelLogicImpl.java）

**テンプレートファイル**（ソースコード根拠: fileProperty.dicon）:
- Excel用: `ネット注文支部別TOP15.xlsx`
- PDF用: `ネット注文支部別TOP15_PDF.xlsx`
- 配置場所: `/data1/bird/netorder`

**シート構成**:
| シート名 | 用途 | ソート順 |
|---------|------|---------|
| data | 標準データ | JIGYOU_CD, SLAREA_CD, SIBU_CD, AREA_DAI, MISE_CD |
| data_area_dai | エリア大別データ | AREA_DAI, MISE_CD |

**出力位置**:
- ヘッダ行2: 出力日（列10 = K列）
- ヘッダ行3: 出力期間（列10 = K列）
- データ開始: 行5（startRow=4）、列J（startColumn=9）

**出力項目**（44項目）:
1. 店舗情報: jigyouCd, jigyouName, slareaCd, slareaName, sibuCd, sibuName, areaDai, areaName, miseCd, miseNameKj, onerCd, onerNameKj
2. 金額情報: otherKin7, otherKin8, eatKin, takeKin, telKin, driveKin, otherKin1, otherKin2
3. 件数情報: otherKen7, otherKen8, eatKen, takeKen, telKen, driveKen, otherKen1, otherKen2
4. 前年金額: zenOtherKin7, zenOtherKin8, zenEatKin, zenTakeKin, zenTelKin, zenDriveKin, zenOtherKin1, zenOtherKin2
5. 前年件数: zenOtherKen7, zenOtherKen8, zenEatKen, zenTakeKen, zenTelKen, zenDriveKen, zenOtherKen1, zenOtherKen2

**数式再計算**:
- `workbook.setForceFormulaRecalculation(true)`
- PDF出力時: `workbook.getCreationHelper().createFormulaEvaluator().evaluateAll()`

#### 3.4.2 ダウンロードファイル名（ソースコード根拠: SearchDto.java）
- 基本名: `ネット注文支部別TOP15`
- 対象年月の場合: `ネット注文支部別TOP15_{yyyyMM}.xlsx` または `.pdf`
- 期間指定の場合: `ネット注文支部別TOP15_{yyyyMMdd}-{yyyyMMdd}.xlsx` または `.pdf`

#### 3.4.3 PDF変換（ソースコード根拠: NetOrderReportDownloadActionImpl.java）
- **変換エンジン**: JODConverter + LibreOffice
- **LibreOfficeパス**: `/opt/libreoffice6.0`（fileProperty.diconより）
- **一時ファイル**: `temp/temp_excel2pdf{timestamp}.xlsx`, `temp/temp_excel2pdf{timestamp}.pdf`
- **Content-Type**: `application/pdf`（CONTENT_TYPE_PDF定数）

#### 3.4.4 Excel Content-Type（ソースコード根拠: NetOrderReportDownloadLogicImpl.java）
- `application/vnd.ms-excel`

### 3.5 データ取得仕様（ソースコード根拠: NetOrderReportDataDao_selectNetOrderReport.sql）

#### 3.5.1 使用テーブル
| テーブル | 用途 |
|---------|------|
| BT63SNIP | ネット注文実績データ |
| BM45ZDAY | 営業日マスタ |
| BM11ONER | オーナーマスタ |
| BM01TENM | 店舗マスタ |
| BM10GSIB | 支部マスタ |
| BM82NOJT | ネット注文除外マスタ |

#### 3.5.2 SQLパラメータ
| パラメータ | 型 | 説明 |
|-----------|---|------|
| staDate | String | 開始日（yyyyMMdd形式） |
| endDate | String | 終了日（yyyyMMdd形式） |
| orderByCd | String | ソート順（"data" or "data_area_dai"） |

#### 3.5.3 日付パラメータ生成ルール（ソースコード根拠: NetOrderReportExcelLogicImpl.java）
- **対象年月の場合**:
  - dateFrom: `{kikanYM}01`
  - dateTo: `{kikanYM}{月末日}` ただしアプリ日付を超えない
- **期間指定の場合**:
  - dateFrom: kikanFrom
  - dateTo: kikanTo

#### 3.5.4 SQL構造
- UNION ALLで本年データと前年データを結合
- 動的ORDER BY（Seasar2コメント構文）:
  ```sql
  /*IF orderByCd.equals("data")*/
      JIGYOU_CD, SLAREA_CD, SIBU_CD, AREA_DAI, MISE_CD
  /*END*/
  /*IF orderByCd.equals("data_area_dai")*/
      AREA_DAI, MISE_CD
  /*END*/
  ```

### 3.6 設定・外部依存（ソースコード根拠: fileProperty.dicon）

| プロパティキー | 値 | 用途 |
|---------------|---|------|
| filePathNetOrderReport | /data1/bird/netorder | テンプレート・一時ファイル配置ディレクトリ |
| fileNameNetOrderReportExcel | ネット注文支部別TOP15.xlsx | Excelテンプレートファイル名 |
| fileNameNetOrderReportPdf | ネット注文支部別TOP15_PDF.xlsx | PDF用テンプレートファイル名 |
| officeHomePath | /opt/libreoffice6.0 | LibreOfficeインストールパス |

### 3.7 文字コード（ソースコード根拠: netorderReport.html）
- 画面: `Windows-31J`（meta charset指定）
- diconファイル: `Shift_JIS`
- Excelファイル名エンコード: `iso-8859-1`（SearchDto.getFileName()）

---

## 4. 新スタックでのレイヤード設計案

### 4.1 レイヤー構成

```
[Angular Frontend]
    ↓ REST API
[Spring Boot Backend]
    ├── Controller層 (REST)
    │   └── NetOrderReportController
    ├── Service層
    │   ├── NetOrderReportConditionService (条件生成)
    │   ├── NetOrderReportService (帳票生成)
    │   └── NetOrderReportLockService (排他制御)
    ├── Repository層
    │   └── NetOrderReportRepository (データ取得)
    └── Infrastructure層
        ├── ExcelGenerator (POI)
        ├── PdfConverter (LibreOffice or 代替)
        └── FileStorage (テンプレート・一時ファイル)
```

### 4.2 API設計案

| エンドポイント | メソッド | 処理内容 | 現行対応 |
|---------------|---------|---------|---------|
| /api/netorder/conditions | GET | 条件プルダウン取得 | initialize() |
| /api/netorder/validate | POST | パラメータ検証 | checkParamater() |
| /api/netorder/download/excel | POST | Excel生成・ダウンロード | downloadExcel() |
| /api/netorder/download/pdf | POST | PDF生成・ダウンロード | downloadPdf() |

### 4.3 フロントエンド設計案

#### 4.3.1 コンポーネント構成
```
NetOrderReportComponent
    ├── ConditionFormComponent (条件入力フォーム)
    ├── DownloadButtonsComponent (ダウンロードボタン)
    └── WaitingMessageComponent (待機メッセージ)
```

#### 4.3.2 現行の自動クリック機構への対応
現行はhiddenフラグ（downloadExcelFlg/downloadPdfFlg）とbodyLoad()での自動クリックでダウンロードを実現している。SPAでは以下の方式に変更:
- ボタンクリック → API呼び出し → Blobレスポンス → ファイルダウンロード
- 待機画面はローディングスピナーで代替

### 4.4 Repository層設計案

#### 4.4.1 SQL移植方針
現行SQLはSeasar2コメント構文（`/*IF*/`, `/*END*/`）を使用した動的SQLのため、以下の選択肢がある:

| 方式 | メリット | デメリット |
|------|---------|-----------|
| Native Query | SQL移植が容易 | JPA恩恵が少ない |
| JPQL + @Query | JPA標準 | 複雑なSQLは困難 |
| QueryDSL | 型安全、動的クエリ | 学習コスト |
| 複数クエリ分岐 | シンプル | コード重複 |

**推奨**: Native Queryで移植し、動的ORDER BYは2つのメソッドに分割

#### 4.4.2 PostgreSQL移行時の注意点
| 項目 | Oracle | PostgreSQL | 対応 |
|------|--------|------------|------|
| 日付型 | DATE | DATE/TIMESTAMP | 型確認必要 |
| 文字列日付比較 | 可能 | 可能 | 形式統一 |
| NULL挙動 | 特有 | 標準SQL | NOT IN注意 |
| 実行計画 | 異なる | 異なる | 性能検証必要 |

---

## 5. 移行時の重要論点

### 5.1 排他制御の再設計（重要度: 高）

#### 5.1.1 問題点
現行のファイルベースロック（`net_order.lock`）はコンテナ水平スケール時に破綻する。

#### 5.1.2 代替案
| 方式 | 説明 | メリット | デメリット |
|------|------|---------|-----------|
| PostgreSQL Advisory Lock | pg_advisory_lock() | DB依存のみ | 接続プール設計必要 |
| Redis分散ロック | Redisson等 | 高速 | Redis依存追加 |
| DBテーブルロック | ロック管理テーブル | シンプル | 性能影響 |

**推奨**: PostgreSQL Advisory Lock（クラウドマネージドサービス非依存要件に適合）

#### 5.1.3 タイムアウト仕様
- 現行: 5分
- 移行後: 同一仕様を維持（要確認）

### 5.2 PDF変換の再設計（重要度: 高）

#### 5.2.1 問題点
- LibreOfficeはコンテナ運用で不安定になりやすい（フォント、メモリ、起動時間）
- 並列変換時の安定性

#### 5.2.2 代替案
| 方式 | 説明 | メリット | デメリット |
|------|------|---------|-----------|
| LibreOffice継続 | コンテナにLibreOffice同梱 | 現行互換 | 運用負荷高 |
| 別コンテナ化 | PDF変換マイクロサービス | スケール可能 | 構成複雑 |
| Java PDF生成 | Apache PDFBox等 | 依存少 | レイアウト再現困難 |
| 帳票エンジン | JasperReports等 | 高機能 | 学習コスト |

**推奨**: LibreOffice別コンテナ化（現行レイアウト互換性重視の場合）

#### 5.2.3 フォント対応
- 日本語フォントのコンテナ同梱が必要
- 現行と同一フォントを使用しないとレイアウト差分が発生

### 5.3 テンプレートファイル管理（重要度: 中）

#### 5.3.1 現行配置
- `/data1/bird/netorder/ネット注文支部別TOP15.xlsx`
- `/data1/bird/netorder/ネット注文支部別TOP15_PDF.xlsx`

#### 5.3.2 コンテナ環境での選択肢
| 方式 | 説明 | メリット | デメリット |
|------|------|---------|-----------|
| イメージ同梱 | Dockerイメージに含める | デプロイ簡単 | 更新時再ビルド |
| ボリュームマウント | 外部ストレージ | 更新容易 | 運用設計必要 |
| オブジェクトストレージ | S3/GCS等 | スケーラブル | クラウド依存 |

**推奨**: ボリュームマウント（クラウドマネージドサービス非依存要件に適合）

### 5.4 一時ファイル管理（重要度: 中）

#### 5.4.1 現行仕様
- 配置: `/data1/bird/netorder/temp/`
- ファイル名: `temp_excel2pdf{timestamp}.xlsx`, `temp_excel2pdf{timestamp}.pdf`
- 削除: 処理完了後に削除

#### 5.4.2 コンテナ環境での考慮点
- エフェメラルストレージの使用
- 異常終了時のクリーンアップ
- 複数Pod間での一時ファイル分離

### 5.5 文字コード対応（重要度: 中）

#### 5.5.1 現行
- 画面: Windows-31J
- ファイル名: iso-8859-1エンコード

#### 5.5.2 移行方針
- 全体UTF-8化
- ファイル名のエンコード方式見直し（RFC 5987準拠）

### 5.6 セッション管理（重要度: 中）

#### 5.6.1 現行
- SearchDto: sessionスコープ
- BirdUserInfo/BirdDateInfo: sessionスコープ

#### 5.6.2 SPA化での変更
- ステートレスAPI設計
- 必要な情報はリクエストパラメータで受け渡し
- ユーザー情報はJWTトークン等で管理

---

## 6. テスト戦略

### 6.1 機能テスト
| テスト項目 | 検証内容 |
|-----------|---------|
| 条件取得 | プルダウンリストの内容が現行と一致 |
| バリデーション | エラーメッセージが現行と一致 |
| Excel出力 | 出力データが現行と一致 |
| PDF出力 | 出力データが現行と一致 |
| 排他制御 | 同時実行時の挙動が現行と一致 |

### 6.2 帳票同一性テスト

#### 6.2.1 検証レベルの選択肢
| レベル | 検証内容 | 工数 |
|--------|---------|------|
| 数値一致 | セル値の一致 | 低 |
| レイアウト一致 | 見た目の一致 | 中 |
| バイナリ一致 | ファイル完全一致 | 高（非現実的） |

**推奨**: 数値一致 + 目視によるレイアウト確認

#### 6.2.2 ゴールデンファイル比較
- 現行システムで生成したExcel/PDFを基準ファイルとして保存
- 移行後システムの出力と比較

### 6.3 性能テスト
| テスト項目 | 検証内容 |
|-----------|---------|
| 最大期間 | 366日分のデータ取得・出力 |
| 大量データ | 対象店舗数が多い場合の応答時間 |
| 同時実行 | 排他制御の動作確認 |

### 6.4 非機能テスト
| テスト項目 | 検証内容 |
|-----------|---------|
| 異常終了 | ロック解除漏れの確認 |
| 一時ファイル | クリーンアップの確認 |
| タイムアウト | 5分経過後のロック解除 |

---

## 7. 移行作業チェックリスト

### 7.1 事前準備
- [ ] テンプレートExcelファイルの入手・配置方法確定
- [ ] LibreOffice継続/代替の方針決定
- [ ] 排他制御方式の決定
- [ ] PostgreSQLへのテーブル移行

### 7.2 バックエンド実装
- [ ] Controller層実装
- [ ] Service層実装
- [ ] Repository層実装（SQL移植）
- [ ] Excel生成処理実装
- [ ] PDF変換処理実装
- [ ] 排他制御実装

### 7.3 フロントエンド実装
- [ ] 条件入力画面実装
- [ ] ダウンロード処理実装
- [ ] 待機画面実装

### 7.4 テスト
- [ ] 単体テスト
- [ ] 結合テスト
- [ ] 帳票同一性テスト
- [ ] 性能テスト
- [ ] 非機能テスト

### 7.5 インフラ
- [ ] コンテナイメージ作成
- [ ] テンプレートファイル配置
- [ ] 一時ファイル領域設定
- [ ] LibreOffice環境構築（継続の場合）

---

## 8. 未確認事項

以下の項目はソースコードからは確認できなかったため、別途確認が必要:

1. **アクセス権限**: この機能を使用できるユーザー種別（BirdUserInfo.getUserTypeCd()の値と権限の関係）
2. **現行DB種別**: SQLの方言からOracleと推測されるが、確定には接続設定の確認が必要
3. **テンプレートファイル**: リポジトリ内に存在しないため、実行環境からの入手が必要
4. **監査ログ**: 誰がいつどの条件で出力したかのログ出力有無

---

## 9. 参照ソースコード一覧

| ファイル | 用途 |
|---------|------|
| NetOrderReportDownloadActionImpl.java | Action実装 |
| NetOrderReportDownloadAction.java | Actionインターフェース |
| ConditionLogicImpl.java | 条件生成Logic |
| NetOrderReportDownloadLogicImpl.java | ファイルパス管理Logic |
| NetOrderReportExcelLogicImpl.java | Excel生成Logic |
| NetOrderReportPdfLogicImpl.java | PDFダウンロードLogic |
| NetOrderReportDataDao.java | DAOインターフェース |
| NetOrderReportDataDao_selectNetOrderReport.sql | データ取得SQL |
| NetOrderReport.java | Entity |
| SearchDto.java | 検索条件DTO |
| TaishoKikan.java | 対象期間コード |
| netorderReport.dicon | DI設定 |
| netorderReport.html | 画面（JSF/Maya） |
| fileProperty.dicon | ファイルパス設定 |
