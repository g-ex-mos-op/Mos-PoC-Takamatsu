# DN-030110-021.02 業務ロジック設計書(ネット注文帳票)

## 概要

本文書は、ネット注文帳票機能の業務ロジック設計書です。ネット注文支部別TOP15帳票のダウンロード機能に関する4つのロジック（検索条件初期化データ取得、EXCEL帳票ダウンロード処理、帳票データ取得とEXCEL作成処理、PDF帳票ダウンロード）の設計を定義しています。

## 文書情報

| 項目 | 内容 |
|------|------|
| 管理番号 | DN-030110-021.02 |
| 分類 | Logic設計書 |
| 作成者 | AO 王増文 |
| 作成日 | 2018/06/05 |
| 更新者 | AO王増文 |
| 更新日 | 2018/09/10 |

---

## 更新履歴

| 作成・更新日 | 更新内容 |
|--------------|----------|
| 2018/06/05 | 新規作成 |
| 2018/09/06 | ネット注文帳票 データ取得しEXCELとPDF帳票出力処理の追加 |

---

## 業務ロジック一覧

| ロジックNO | 業務ロジック名 | 機能概要 | ルールクラス | ステータス | 更新日 | 担当 |
|------|------|------|------|------|------|------|
|  | BBR019L01 | LOGIC【検索条件初期化データ取得】 |  |  |  |  |
|  | BBR019L02 | LOGIC【EXCEL帳票ダウンロード処理】 |  |  |  |  |
|  | BBR019L03 | LOGIC【帳票データ取得とEXCEL作成処理】 |  |  |  |  |
|  | BBR019L04 | LOGIC【PDF帳票ダウンロード】 |  |  |  |  |

---

## BBR019L01: 検索条件初期化データ取得

### 基本情報

| 項目 | 内容 |
|------|------|
| 機能概要 | EXCELのダウンロード |
| ロジッククラス | jp.co.isid.mos.bird.bizreport.netorderreport.logic.impl.ConditionLogicImpl |
| ロジックNO | BBR019L01 |
| ステータス |  |
| TX属性 | NotSupported |

### インタフェース定義

#### パラメータ

| 項目名 | データタイプ | 内容 |
|--------|--------------|------|
| ユーザタイプ | String |  |
| ユーザID | String |  |
| アプリ日付 | String |  |

#### リターン

| 項目名 | データタイプ | 内容 |
|--------|--------------|------|
| 対象期間リスト | Map | [対象年月], [期間指定] |
| 期間指定年月リスト | Map | アプリ日付の月を含め、過去１４ヵ月の月まで。<br>例：アプリ日付9月17日<br>2017年8月～2018年9月 |
| 期間指定FROM日付リスト | Map | アプリ日付を含め、過去１４ヵ月の月の1日まで。<br>例：アプリ日付9月17日<br>2017年8月1日～2018年9月17日 |
| 期間指定TO日付リスト | Map | アプリ日付を含め、過去１４ヵ月の月の1日まで。<br>例：アプリ日付9月17日<br>2017年8月1日～2018年9月17日 |

### データI/O定義

| 使用Dao名 | Daoクラス名 |
|-----------|-------------|
| なし |  |

### その他importクラス

| クラス名 | パッケージ |
|----------|------------|
| 対象期間の定数クラス | jp.co.isid.mos.bird.bizreport.netorderreport.code.TaishoKikan; |
| 共通定数クラス | jp.co.isid.mos.bird.bizreport.common.common.BizReportConstants; |

### コントラクト定義

#### 事前条件

| 条件 | メッセージID |
|------|--------------|
| 画面初期表示 |  |

#### 事後条件

| 条件 | メッセージID |
|------|--------------|
| 検索条件の値を画面上各プルダウンにセットする |  |

### ロジック定義

#### 処理内容


**1. 対象期間のデータを取得する。**

- TaishoKikanクラスから、 定義する定数を取得する。
- {MONTH, "対象年月"},
- {DAYS, "期間指定"}};

**２．年月データを作成する。**

- アプリ日付を元に、当月を含め、過去１４ヵ月の月まで年月データリストを作成する。

**３．期間指定FROM日付リストデータを作成する。**

- アプリ日付を元に、本日を含め、過去１４ヵ月の月の1日までの日付データリストを作成する。

**４．期間指定TO日付リストデータを作成する。**

- 上記３と同じ。

---

## BBR019L02: EXCEL帳票ダウンロード処理

### 基本情報

| 項目 | 内容 |
|------|------|
| 機能概要 | EXCEL帳票ファイルのダウンロード |
| ロジッククラス | jp.co.isid.mos.bird.bizreport.netorderreport.logic.impl.NetOrderReportDownloadLogicImpl |
| ロジックNO | BBR019L02 |
| ステータス |  |
| TX属性 | NotSupported |

### インタフェース定義

#### パラメータ

| 項目名 | データタイプ | 内容 |
|--------|--------------|------|
| DownloadDto | DTOクラス |  |

#### リターン

| 項目名 | データタイプ | 内容 |
|--------|--------------|------|
| ダウンロードファイル名 |  |  |
| ダウンロードファイルパス |  |  |
| EXCEL2PDF変換するTEMPファイル名 |  |  |

### データI/O定義

| 使用Dao名 | Daoクラス名 |
|-----------|-------------|
| なし |  |

### その他importクラス

| クラス名 | パッケージ |
|----------|------------|
| DownloadLogic インタフェースをimplements | jp.co.isid.mos.bird.framework.dto.DownloadDto.DownloadLogic |
| ネット注文データ検索DTO | jp.co.isid.mos.bird.bizreport.netorderreport.dto.SearchDto |

### コントラクト定義

#### 事前条件

| 条件 | メッセージID |
|------|--------------|
| 帳票ファイルが正常生成すること。 | E0103 |

#### 事後条件

| 条件 | メッセージID |
|------|--------------|
| 帳票ファイルを正常に取得できること。 |  |
| ダウンロードを行う |  |

### ロジック定義

#### 処理内容


**１．テンプレートファイル名取得処理**

- EXCELテンプレートファイル名： ネット注文支部別TOP15.xlsx  （共通クラスで、プロパティ定義ファイルから取得）
- PDFテンプレートファイル名： ネット注文支部別TOP15_PDF.xlsx  （共通クラスで、プロパティ定義ファイルから取得）

**２．テンプレートファイルのパス取得する。**

- フォルダ： /data1/bird/netorder （共通クラスで、プロパティ定義ファイルから取得）

**３．EXCEL2PDF変換前のEXCELのTEMPファイル名とEXCEL2PDF変換後PDFのTEMPファイル名取得処理**

- 変換前のEXCELファイル： temp/temp_excel2pdf.xlsx
- 変換後のPDFファイル： temp/temp_excel2pdf.pdf
- フォルダ： /data1/bird/netorder （共通クラスで、プロパティ定義ファイルから取得）

**４．ダウンロードファイルタイプ： application/vnd.ms-excel**


---

## BBR019L03: 帳票データ取得とEXCEL作成処理

### 基本情報

| 項目 | 内容 |
|------|------|
| 機能概要 | 帳票データ取得とEXCEL作成処理 |
| ロジッククラス | jp.co.isid.mos.bird.bizreport.netorderreport.logic.impl.NetOrderReportExcelLogicImpl |
| ロジックNO | BBR019L03 |
| ステータス |  |
| TX属性 | NotSupported |

### インタフェース定義

#### パラメータ

| 項目名 | データタイプ | 内容 |
|--------|--------------|------|
| ExcelOutputDto | DTOクラス |  |

#### リターン

| 項目名 | データタイプ | 内容 |
|--------|--------------|------|
| 生成したEXCELファイル |  |  |

### データI/O定義

| 使用Dao名 | Daoクラス名 |
|-----------|-------------|
| NetOrderReportDataDao | jp.co.isid.mos.bird.bizreport.netorderreport.dao.NetOrderReportDataDao |

### その他importクラス

| クラス名 | パッケージ |
|----------|------------|
| ExcelOutputLogic インタフェースをimplements | jp.co.isid.mos.bird.framework.dto.DownloadDto.DownloadLogic |
| ネット注文帳票DTO | jp.co.isid.mos.bird.bizreport.netorderreport.dto.NetOrderReportDownloadDto |

### コントラクト定義

#### 事前条件

| 条件 | メッセージID |
|------|--------------|
| 帳票EXCELファイルが正常生成すること。 | E0103 |

#### 事後条件

| 条件 | メッセージID |
|------|--------------|
| 帳票ファイルを正常に取得できること。 |  |

### ロジック定義

#### 処理内容


**１．帳票EXCELファイル名取得処理**

- EXCELテンプレートファイル名： ネット注文支部別TOP15.xlsx  （共通クラスで、プロパティ定義ファイルから取得）
- PDF帳票のテンプレートファイル名： ネット注文支部別TOP15_PDF.xlsx  （共通クラスで、プロパティ定義ファイルから取得）

**２．テンプレートファイルのパス取得する。**

- フォルダ： /data1/bird/netorder （共通クラスで、プロパティ定義ファイルから取得）

**３．NetOrderreportDataDaoをコールし、DBから検索し、帳票データを取得する。**


**４．取得したデータをテンプレートのデータシートにセットする。**

- ４－１．EXCEL帳票出力の場合、
- ４－１－１．ソート順1,3,5,7,9 のSQL文を実行し、データを
- テンプレートのdataシートに、J列～BA列までデータをセットする。
- ４－１－２．ソート順 7,9 のSQL文を実行し、データを
- テンプレートのdata_area_daiシートに、J列～BA列までデータをセットする。
- ４－１－３．EXCELの自動計算フラグ＝TRUEにする。 （※EXCEL帳票ダウンロードした後、初めて開いた時、EXCEL計算式を実行する）
- ４ー２．PDF帳票出力の場合、
- ４－２－１．ソート順1,3,5,7,9 のSQL文を実行し、データを
- テンプレートのdataシートに、J列～BA列までデータをセットする。
- ４－２－２．ソート順 7,9 のSQL文を実行しない。 「data_area_dai」シートは存在しないため、データもセットしない。
- ４－２－３．EXCELの自動計算フラグ＝TRUEにする。
- ４－２－４．POIのworkbook.getCreationHelper().createFormulaEvaluator().evaluateAll()をコールし、直ちにEXCEL自動計算を実行する。

---

## BBR019L04: PDF帳票ダウンロード

### 基本情報

| 項目 | 内容 |
|------|------|
| 機能概要 | PDFダウンロード処理 |
| ロジッククラス | jp.co.isid.mos.bird.bizreport.netorderreport.logic.impl.NetOrderReportPdfLogicImpl |
| ロジックNO | BBR019L04 |
| ステータス |  |
| TX属性 | NotSupported |

### インタフェース定義

#### パラメータ

| 項目名 | データタイプ | 内容 |
|--------|--------------|------|
| downloadDto | DTOクラス |  |

#### リターン

| 項目名 | データタイプ | 内容 |
|--------|--------------|------|
| PDFファイル |  |  |

### データI/O定義

| 使用Dao名 | Daoクラス名 |
|-----------|-------------|
| なし |  |

### その他importクラス

| クラス名 | パッケージ |
|----------|------------|
| DownloadLogicインタフェースをimplements | jp.co.isid.mos.bird.framework.dto.DownloadDto.DownloadLogic |
| 検索条件DTO | jp.co.isid.mos.bird.bizreport.netorderreport.dto.SearchDto |

### コントラクト定義

#### 事前条件

| 条件 | メッセージID |
|------|--------------|
| 帳票PDFファイルが正常生成すること。 | E0103 |

#### 事後条件

| 条件 | メッセージID |
|------|--------------|
| 帳票ファイルを正常に取得できること。 |  |

### ロジック定義

#### 処理内容


**１．ダウンロードPDFテンプレートファイル名を取得処理**

- ダウンロードPDFテンプレートファイル名： ネット注文支部別TOP15_YYYYMM.pdf （対象年月で検索場合）
- ネット注文支部別TOP15_YYYYMMDD-YYYYMMDD.pdf （期間で検索場合）

**２．テンプレートファイルのパス取得する。**

- フォルダ： /data1/bird/netorder （共通クラスで、プロパティ定義ファイルから取得）

**３．ダウンロードファイルタイプ設定： application/pdf**


---

## 読み取りが難しかった項目

- **.xls形式での画像抽出不可**: xlrdライブラリでは画像・図形の抽出がサポートされていないため、シート内の画像や図形は抽出できませんでした。
- **結合セルのレイアウト再現**: 一部の結合セルで、元のレイアウトが完全に再現できていない可能性があります。
- **日付データの変換**: Excelのシリアル値から日付への変換を行いましたが、一部の日付データが正確に変換されていない可能性があります。
- **長いテキストの切り捨て**: 一部のセルで長いテキストが含まれている場合、表示が途切れている可能性があります。

## 不明点・不明瞭な点

- **空欄の項目**: 業務ロジック一覧シートの「機能概要」「ルールクラス」「ステータス」「更新日」「担当」列が空欄になっています。
- **パラメータの必須・初期値**: 各ロジックのパラメータ定義で、必須フラグと初期値が空欄になっている項目があります。
- **リターン値の詳細**: 一部のロジックでリターン値のデータタイプや内容が空欄になっています。
- **メッセージID**: コントラクト定義の事前条件・事後条件で、メッセージIDが空欄の項目があります。
- **クラス名の省略**: ロジッククラス名やパッケージ名が長いため、一部が省略されている可能性があります。
