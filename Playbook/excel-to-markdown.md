# Excelファイルをマークダウンに変換

## Overview

Excelファイル（.xls/.xlsx）の内容を読み取り、シートごとにセクションを分けたマークダウンファイルを作成する。テキスト、表形式のデータ、および画像を対象とする。

## What's Needed From User

- 変換対象のExcelファイルのパス
  - 例：`Migration/Documents/ネット注文帳票/DN-030110-021.02 業務ロジック設計書(ネット注文帳票).xls`

## Procedure

1. 対象のExcelファイルの存在と拡張子（.xls または .xlsx）を確認する
2. Pythonライブラリをインストールする：`python3 -m pip install pandas xlrd openpyxl pillow`
3. Pythonスクリプトで全シートを読み取る
   - 全シート読み取り：`pandas.read_excel(file, sheet_name=None, engine=...)`
   - `.xls`形式：`engine="xlrd"`
   - `.xlsx`形式：`engine="openpyxl"`
   - `sheet_name=None`を指定することで全シートを辞書形式で取得
4. 結合セルを適切に処理する（下記「結合セルの処理」参照）
5. シート内の画像を抽出・解析する（下記「画像の処理」参照）
6. 各シートの内容をマークダウン形式に変換する
   - 表形式のデータはマークダウンテーブルに変換
   - 表以外のレイアウト文章は行順に段落として出力
7. 文書情報セクションを作成する（下記「文書情報セクションの構成」参照）
8. シートごとのセクションを作成する（シート名をヘッダーとして使用）
9. 「読み取りが難しかった項目」セクションを作成する
10. 「不明点・不明瞭な点」セクションを作成する
11. 出力ファイルを元のExcelファイルと同じディレクトリに保存する
    - ファイル名：元のファイル名の拡張子を`.md`に変更
    - 例：`DN-030110-021.02 業務ロジック設計書(ネット注文帳票).xls` → `DN-030110-021.02 業務ロジック設計書(ネット注文帳票).md`
12. 生成したマークダウンファイルを検証する
    - Excelのシート名一覧とマークダウン内のセクション名が一致すること
    - シート数が一致すること
    - 表がマークダウンテーブル形式（`|`区切り）になっていること

## Specifications

### 出力フォーマット

```markdown
# [ドキュメントタイトル（ファイル名から取得）]

## 文書情報

| 項目 | 内容 |
|------|------|
| 管理番号 | [管理番号] |
| 分類 | [分類] |
| 作成者 | [作成者] |
| 作成日 | [作成日] |
| 更新者 | [更新者] |
| 更新日 | [更新日] |

## 更新履歴

| 作成・更新日 | 更新内容 | 作成・更新者 | レビュー/承認者 | レビュー/承認日 |
|--------------|----------|--------------|-----------------|-----------------|
| [日付] | [内容] | [担当者] | [レビュー者] | [日付] |

---

## [シート名1]

[シート1の内容]

---

## [シート名2]

[シート2の内容]

---

## 読み取りが難しかった項目

[Excel変換時に読み取りが困難だった項目や情報が失われた可能性がある項目を記載]

## 不明点・不明瞭な点

[仕様として不明確または追加の確認が必要な点を記載]
```

### 文書情報セクションの構成

文書情報には以下の項目を含める（Excelファイルから取得できる場合）：
- 管理番号
- 分類（設計書の種類：Dao設計書、業務ロジック設計書、画面設計書など）
- 作成者・作成日
- 更新者・更新日

情報の取得元：
- 「更新履歴」「変更履歴」などの名前のシートがあれば優先的に参照
- ファイル名から管理番号を抽出（例：`DN-030110-021.02`）
- 各シートのヘッダー部分

### 結合セルの処理

openpyxlを使用して結合セルを適切に処理する：

```python
from openpyxl import load_workbook

wb = load_workbook(file_path)
for sheet in wb.worksheets:
    # 結合セルの範囲を取得
    merged_ranges = list(sheet.merged_cells.ranges)
    
    for merged_range in merged_ranges:
        # 結合セルの左上の値を取得
        top_left_cell = sheet.cell(merged_range.min_row, merged_range.min_col)
        top_left_value = top_left_cell.value
        
        # 結合を解除
        sheet.unmerge_cells(str(merged_range))
        
        # 結合範囲内のすべてのセルに左上の値を設定
        for row in range(merged_range.min_row, merged_range.max_row + 1):
            for col in range(merged_range.min_col, merged_range.max_col + 1):
                sheet.cell(row, col).value = top_left_value
```

### 画像の処理

シート内の画像を抽出し、内容を解析してマークダウンに変換する：

1. **画像の抽出**：openpyxlの`_images`属性を使用してシート内の画像を取得
2. **画像の解析**：抽出した画像の内容を解析し、以下のいずれかの形式でマークダウンに変換
   - 図表・フローチャートの場合：テキストで構造を説明
   - スクリーンショットの場合：画面の内容を説明
   - グラフの場合：グラフの種類とデータの傾向を説明
3. **マークダウンへの出力**：`### 図: [図の説明]`の形式で記載

```python
from openpyxl import load_workbook

wb = load_workbook(file_path)
for sheet in wb.worksheets:
    for image in sheet._images:
        # 画像データを取得
        image_data = image._data()
        # 画像の位置情報を取得
        anchor = image.anchor
        # 画像を解析してマークダウンに変換
```

### 成功条件

- すべてのシートがマークダウンファイルに含まれている
- 表形式のデータはマークダウンのテーブル形式で表現されている
- 結合セルが適切に処理され、データが欠落していない
- シート内の画像が解析され、マークダウンの図として記載されている
- 日本語が正しく表示されている
- 出力ファイルが元のファイルと同じディレクトリに保存されている
- 「読み取りが難しかった項目」セクションが含まれている
- 「不明点・不明瞭な点」セクションが含まれている

## Advice and Pointers

- **結合セル**：openpyxlで結合セルの範囲を取得し、結合を解除してから左上セルの値を全セルに設定する。pandasのread_excelだけでは結合セルの値が正しく取得できない場合がある
- **空シート**：セクションは作成し、「内容なし」と記載する
- **数式セル**：キャッシュされた計算結果を取得する。未計算の場合はその旨を「読み取りが難しかった項目」セクションに記載する
- **1シート内に複数テーブル**：表ブロックごとに`###`見出しで区切る
- **画像・図**：シート内の画像を抽出し、内容を解析してマークダウンの図として記載する。解析が困難な場合は「読み取りが難しかった項目」セクションに記載する
- **日付データ**：Excelの日付はシリアル値として格納されている場合があるため、適切な日付形式に変換する。変換が不確実な場合は「読み取りが難しかった項目」セクションに記載する
- **文字化け**：一部のセルで文字化けが発生する場合がある。該当箇所は「読み取りが難しかった項目」セクションに記載する

## Forbidden Actions

- 元のExcelファイルを変更・削除しない
- シートの内容を省略しない（空シートもセクションとして含める）
- 「読み取りが難しかった項目」セクションを省略しない
- 「不明点・不明瞭な点」セクションを省略しない
