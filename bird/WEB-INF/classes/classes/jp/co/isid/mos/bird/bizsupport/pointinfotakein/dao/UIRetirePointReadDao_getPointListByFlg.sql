SELECT
	BD64.TMSP,
	BD64.NENDO,
	RTRIM(BD64.USER_ID) AS USER_ID,
	BD64.TORI_SAKUJO_FLG,
	SUM_POINT.POINTSUM AS POINT_RUIKEI,
	BD64.KB_COMPANY_CD,
	BD64.NYUSYA_DT,
	BD64.TAISHOKU_DT,
	BD64.KINZOKU_YEAR,
	BD64.RETIRE_CD,
	SUM_POINT.SIKYU_RATE,
	SUM_POINT.POINT+COALESCE(BD59.POINT,0) AS T_SEISAN_POINT,
	RTRIM(BD64.BIKOU) AS BIKOU,
	BD64.FIRST_USER,
	BD64.FIRST_PGM,
	BD64.FIRST_TMSP,
	BD64.LAST_USER,
	BD64.LAST_PGM,
	BD64.LAST_TMSP

FROM
    BD64TSES BD64 INNER JOIN
    (SELECT
    		BD64.TMSP,
     		BD64.USER_ID,
    		BD64.NENDO,
    		BD64.NYUSYA_DT,
    		SUM(BD59.POINT) AS POINTSUM,
    		BM80.SIKYU_RATE,
    		SUM(BD59.POINT)* BM80.SIKYU_RATE AS POINT
    FROM
    BD64TSES BD64
      INNER JOIN BM80RESI BM80
        ON (BD64.KB_COMPANY_CD = BM80.KB_COMPANY_CD
        	AND BD64.RETIRE_CD = BM80.RETIRE_CD
        	AND BD64.KINZOKU_YEAR >= BM80.WORK_YEAR_FROM
        	AND BD64.KINZOKU_YEAR <= BM80.WORK_YEAR_TO)
     LEFT OUTER JOIN BD59HPRI BD59
     	ON (BD64.USER_ID = BD59.USER_ID
     		AND BD59.KAIGAI_FLG <> '1'
     		AND BD59.POINT_SHU <>'9')
     GROUP BY
     		BD64.TMSP,
     		BD64.USER_ID,
    		BD64.NENDO,
    		BD64.NYUSYA_DT,
    		BM80.SIKYU_RATE
    ) AS SUM_POINT
    ON (BD64.USER_ID = SUM_POINT.USER_ID
			AND BD64.TMSP=SUM_POINT.TMSP
			AND BD64.NENDO=SUM_POINT.NENDO
			AND BD64.NYUSYA_DT=SUM_POINT.NYUSYA_DT)

     INNER JOIN (
     	SELECT SUM(BD59_80.POINT) AS POINT,
     		BD64.TMSP,
     		BD64.USER_ID,
    		BD64.NENDO,
    		BD64.NYUSYA_DT
    	FROM BD64TSES BD64
    	LEFT OUTER JOIN BD59HPRI BD59_80
    	ON (BD64.USER_ID = BD59_80.USER_ID
     		AND BD59_80.KAIGAI_FLG <> '1'
     		AND BD59_80.POINT_SHU ='9'
     		AND BD59_80.KB_COMPANY_CD='84')
     	GROUP BY
     		BD64.TMSP,
     		BD64.USER_ID,
    		BD64.NENDO,
    		BD64.NYUSYA_DT
     )  BD59
     ON (BD64.USER_ID = BD59.USER_ID
			AND BD64.TMSP=BD59.TMSP
			AND BD64.NENDO=BD59.NENDO
			AND BD64.NYUSYA_DT=BD59.NYUSYA_DT)

WHERE BD64.TMSP = /*tmsp*/'2017-02-23 17:41:09.144000'
	AND BD64.TORI_SAKUJO_FLG = '0'