select
    DECIMAL(SUM(TOTAL.URIAGE1)) AS URIAGE1,
    DECIMAL(SUM(TOTAL.URIAGE2)) AS URIAGE2,
    DECIMAL(SUM(TOTAL.URIAGE3)) AS URIAGE3,
    DECIMAL(SUM(TOTAL.URIAGE4)) AS URIAGE4,
    DECIMAL(SUM(TOTAL.URIAGE5)) AS URIAGE5,
    DECIMAL(SUM(TOTAL.URIAGE1 + TOTAL.URIAGE2 + TOTAL.URIAGE3 + TOTAL.URIAGE4 + TOTAL.URIAGE5)) AS TOTAL_URIAGE,
    SUM(TOTAL.TAX1) TAX1,
    SUM(TOTAL.TAX2) TAX2,
    SUM(TOTAL.TAX3) TAX3,
    SUM(TOTAL.TAX4) TAX4,
    SUM(TOTAL.TAX5) TAX5,
    SUM(TOTAL.TAX1 + TOTAL.TAX2 + TOTAL.TAX3 + TOTAL.TAX4 + TOTAL.TAX5) AS TOTAL_TAX
from
(SELECT A.EIGYO_DT
,      A.MISE_CD AS MISE_CD
,    MAX(A.MISE_NAME) AS MISE_NAME
,    MAX(A.CLOSE_FLG) AS CLOSE_FLG
,    SUM(A.U01_URIAGE1) AS URIAGE1
,    SUM(A.U02_URIAGE2) AS URIAGE2
,    SUM(A.U03_URIAGE3) AS URIAGE3
,    SUM(A.U04_URIAGE4) AS URIAGE4
,    SUM(A.U05_URIAGE5) AS URIAGE5
,    SUM(A.U01_URIAGE1 + A.U02_URIAGE2 + A.U03_URIAGE3 + A.U04_URIAGE4 + A.U05_URIAGE5) AS TOTAL_URIAGE
,    SUM(A.U06_TAX1) AS TAX1
,    SUM(A.U07_TAX2) AS TAX2
,    SUM(A.U08_TAX3) AS TAX3
,    SUM(A.U09_TAX4) AS TAX4
,    SUM(A.U10_TAX5) AS TAX5
,    SUM(A.U06_TAX1 + A.U07_TAX2 + A.U08_TAX3 + A.U09_TAX4 + A.U10_TAX5) AS TOTAL_TAX
FROM
(
SELECT
	COALESCE(BD66.EIGYO_DT,BD65.EIGYO_DT,BT97.EIGYO_DT) AS EIGYO_DT,
    BM01.MISE_NAME_KJ AS MISE_NAME,
    (case when BM01.CLOSE_DT < /*sysDate*/'20070301' then 1 else 0 end) AS CLOSE_FLG,
	COALESCE(BD66.MISE_CD,BD65.MISE_CD,BT97.MISE_CD) AS MISE_CD,
	COALESCE(BD66.U01_URIAGE1,BD65.URIAGE1,BT97.URIAGE) AS U01_URIAGE1,
	COALESCE(BD66.U02_URIAGE2,BD65.URIAGE2,0) AS U02_URIAGE2,
	COALESCE(BD66.U03_URIAGE3,BD65.URIAGE3,0) AS U03_URIAGE3,
	COALESCE(BD66.U04_URIAGE4,BD65.URIAGE4,0) AS U04_URIAGE4,
	COALESCE(BD66.U05_URIAGE5,BD65.URIAGE5,0) AS U05_URIAGE5,
	COALESCE(BD66.U06_TAX1,BD65.TAX1,BT97.TAX) AS U06_TAX1,
	COALESCE(BD66.U07_TAX2,BD65.TAX2,0) AS U07_TAX2,
	COALESCE(BD66.U08_TAX3,BD65.TAX3,0) AS U08_TAX3,
	COALESCE(BD66.U09_TAX4,BD65.TAX4,0) AS U09_TAX4,
	COALESCE(BD66.U10_TAX5,BD65.TAX5,0) AS U10_TAX5
FROM
(
SELECT
    BT97.MISE_CD,
	BT97.COMPANY_CD,
	BT97.EIGYO_DT,
	BT97.UP_DT,
	BT97.U01_URIAGE AS URIAGE,
	BT97.U06_TAX AS TAX
FROM
    BT97ADUP BT97
WHERE
      BT97.COMPANY_CD = /*companyCd*/'00'
AND   BT97.UP_DT = /*syuseiDate*/'20181107'
    ) BT97
	 LEFT OUTER JOIN BM01TENM BM01 ON
       BT97.COMPANY_CD = BM01.COMPANY_CD
AND    BT97.MISE_CD = BM01.MISE_CD
	 LEFT OUTER JOIN BD65SADM BD65 ON
       BT97.COMPANY_CD = BD65.COMPANY_CD
AND    BT97.MISE_CD = BD65.MISE_CD
AND    BT97.EIGYO_DT = BD65.EIGYO_DT
    LEFT OUTER JOIN BD66ADUM BD66 ON
       BT97.COMPANY_CD = BD66.COMPANY_CD
AND    BT97.MISE_CD = BD66.MISE_CD
AND    BT97.EIGYO_DT = BD66.EIGYO_DT
AND    BT97.UP_DT = BD66.UP_DT
) A
GROUP BY A.EIGYO_DT,A.MISE_CD
ORDER BY
A.MISE_CD,
A.EIGYO_DT)TOTAL
